const textToCopy = 'function extractPageData() {\n    // Clipboard function - will only work when called from user action\n    function copyToClipboard(text) {\n        return new Promise((resolve, reject) => {\n            if (navigator.clipboard && navigator.clipboard.writeText) {\n                navigator.clipboard.writeText(text).then(resolve).catch(err => {\n                    console.error(\'Clipboard API failed, trying fallback:\', err);\n                    fallbackCopyTextToClipboard(text, resolve, reject);\n                });\n            } else {\n                fallbackCopyTextToClipboard(text, resolve, reject);\n            }\n        });\n    }\n\n    function fallbackCopyTextToClipboard(text, resolve, reject) {\n        const textArea = document.createElement(\"textarea\");\n        textArea.value = text;\n        textArea.style.position = \"fixed\";  // Prevent scrolling to bottom\n        document.body.appendChild(textArea);\n        textArea.focus();\n        textArea.select();\n\n        try {\n            // This must be called during a user gesture\n            const successful = document.execCommand(\'copy\');\n            document.body.removeChild(textArea);\n            if (successful) {\n                resolve();\n            }\n        } catch (err) {\n            document.body.removeChild(textArea);\n            reject(err);\n        }\n    }\n\n    // Date finding function\n    function findClosestDate() {\n        const highlightedItem = document.querySelector(\'.ring-theme-primary\');\n        if (highlightedItem) {\n            const itemGroup = highlightedItem.closest(\'[data-item-group-index]\');\n            if (itemGroup) {\n                const allSiblings = Array.from(itemGroup.parentElement.children);\n                const groupIndex = allSiblings.indexOf(itemGroup);\n                for (let i = groupIndex - 1; i >= 0; i--) {\n                    const sibling = allSiblings[i];\n                    if (sibling.matches(\'div[data-index]\') &&\n                        sibling.classList.contains(\'px-2\') &&\n                        sibling.classList.contains(\'py-1\')) {\n                        return sibling.textContent.trim();\n                    }\n                }\n            }\n        }\n        const dateDivs = document.querySelectorAll(\'div[data-index].px-2.py-1\');\n        return dateDivs.length > 0 ? dateDivs[0].textContent.trim() : null;\n    }\n\n    // Data extraction function\n    function getExtractedDataAsJson() {\n        const extractedData = {\n            \"url\": document.getElementById(\'image-url\')?.value?.trim() || \"\",\n            \"model\": document.querySelector(\'p.font-semibold.text-sm.break-all.hyphens-auto a[href*=\"/model/\"]\')?.textContent?.trim() || \"\",\n            \"Prompt\": \"\",\n            \"Tags\": [],\n            \"LoRA\": {},\n            \"Sampling Method\": document.querySelector(\'div[role=\"combobox\"][aria-expanded=\"false\"].MuiSelect-select\')?.textContent?.trim() || \"\",\n            \"Sampling Steps\": parseInt(document.querySelector(\'input[type=\"number\"].MuiInputBase-input.css-in64xc[min=\"1\"][max=\"50\"]\')?.value) || null,\n            \"CFG Scale\": parseFloat(document.querySelector(\'input[type=\"number\"].MuiInputBase-input.css-in64xc[min=\"1.1\"][max=\"15\"]\')?.value) || null,\n            \"ranking\": 0,\n            \"Date\": findClosestDate()\n        };\n\n        // Prompt extraction\n        const promptSection = document.querySelector(\'section.z-10.px-4.py-3.pb-2.bg-neutral-100.dark\\\\:bg-neutral-700.rounded-xl.mx-4.flex.flex-col\');\n        if (promptSection) {\n            extractedData.Prompt = promptSection.querySelector(\'textarea[placeholder=\"You can generate images by entering sentences like: &quot;A girl with red hair dressed in a white dress is sitting on a couch with her head tilted.&quot;"]\')?.value?.trim() ||\n                                   promptSection.querySelector(\'textarea\')?.value?.trim() ||\n                                   \"\";\n        }\n\n        // Tags extraction\n        const tagItems = document.getElementById(\'tags-list\')?.querySelectorAll(\'.tag-item\');\n        if (tagItems?.length > 0) {\n            extractedData.Tags = Array.from(tagItems).map(tag =>\n                tag.textContent.trim().replace(/Ã—$/, \'\').trim().toLowerCase());\n        }\n\n        // LoRA extraction\n        document.querySelectorAll(\'div.relative.flex.gap-3.bg-background-light.p-2.rounded-xl\').forEach(entry => {\n            const title = entry.querySelector(\'a.font-bold.text-sm\')?.textContent?.replace(/&amp;/g, \'&\').trim();\n            const weight = parseFloat(entry.querySelector(\'input[type=\"number\"].MuiInputBase-input\')?.value);\n            if (title && !isNaN(weight)) {\n                extractedData.LoRA[title] = weight;\n            }\n        });\n\n        // Clean empty fields\n        if (Object.keys(extractedData.LoRA).length === 0) delete extractedData.LoRA;\n        if (extractedData.Tags.length === 0) delete extractedData.Tags;\n        if (!extractedData.Date) delete extractedData.Date;\n\n        return JSON.stringify(extractedData, null, 2);\n    }\n\n    // Main function to handle user interaction\n    async function handleExtraction() {\n        const jsonOutput = getExtractedDataAsJson();\n        console.log(\"--- Extracted Data ---\", jsonOutput);\n\n        try {\n            await copyToClipboard(jsonOutput);\n        } catch (err) {\n            console.error(\"Copy failed:\", err);\n        }\n    }\n\n    // Create UI button\n    function createCopyButton() {\n        let copyButton = document.getElementById(\'dynamic-copy-button\');\n        if (!copyButton) {\n            copyButton = document.createElement(\'button\');\n            copyButton.id = \'dynamic-copy-button\';\n            copyButton.textContent = \'Copy Image Data\';\n\n            // Apply styles to mimic general button appearance (from previous working version)\n            copyButton.style.padding = \'3px 8px\';\n            copyButton.style.backgroundColor = \'#4285F4\'; // Google Blue background\n            copyButton.style.color = \'white\';\n            copyButton.style.border = \'2px solid #CC0000\'; // Tame Red border\n            copyButton.style.borderRadius = \'9999px\';\n            copyButton.style.cursor = \'pointer\';\n            copyButton.style.boxShadow = \'0 2px 5px rgba(0,0,0,0.2)\';\n            copyButton.style.fontSize = \'0.875rem\';\n            copyButton.style.fontWeight = \'500\';\n            copyButton.style.lineHeight = \'1.25rem\';\n            copyButton.style.marginLeft = \'auto\'; // Push to the right\n            copyButton.style.position = \'relative\'; // Important for containing any absolutely positioned elements\n            copyButton.style.transition = \'background-color 0.075s ease-out, border-color 0.075s ease-out, color 0.075s ease-out\';\n            copyButton.style.outline = \'none\';\n\n            copyButton.addEventListener(\'click\', (e) => {\n                e.preventDefault();\n                handleExtraction();\n                copyButton.textContent = \'Copied!\';\n                setTimeout(() => {\n                    copyButton.textContent = \'Copy Image Data\';\n                }, 2000);\n            });\n\n            // Target the section that contains the "Add Booster" button\n            const boosterButtonSection = document.querySelector(\'section.flex.flex-wrap.gap-2.items-center\');\n\n            if (boosterButtonSection) {\n                // Find the "Add Booster" button more robustly by its text content\n                const addBoosterButton = Array.from(boosterButtonSection.querySelectorAll(\'button\')).find(button =>\n                    button.textContent.includes(\'Add Booster\')\n                );\n\n                if (addBoosterButton) {\n                    addBoosterButton.after(copyButton); // Insert the copy button directly after the booster button\n                } else {\n                    boosterButtonSection.appendChild(copyButton); // Fallback: Append to the section\n                }\n            } else {\n                // Ultimate fallback: append to body if target section not found\n                document.body.appendChild(copyButton); \n            }\n        }\n        return copyButton;\n    }\n\n    // Initialize\n    createCopyButton();\n    return getExtractedDataAsJson();\n}\n\nextractPageData(); // Directly call the function';

const copyButton = document.getElementById('copy-quick-entry');
copyButton.addEventListener('click', () => {
    navigator.clipboard.writeText(textToCopy)
        .then(() => {
            console.log('Extractor function copied to clipboard!');
            const originalButtonText = copyButton.textContent;
            copyButton.textContent = 'Copied!';
            setTimeout(() => {
                copyButton.textContent = originalButtonText;
            }, 1500);
        })
        .catch(err => {
            console.error('Failed to copy extractor function:', err);
            alert('Failed to copy. Please try again or copy manually.');
        });
});
